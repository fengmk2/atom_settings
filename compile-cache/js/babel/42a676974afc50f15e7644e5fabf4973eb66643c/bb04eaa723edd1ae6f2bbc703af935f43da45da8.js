/* globals atom */
'use strict';
var CompositeDisposable = require('atom').CompositeDisposable;
var emissary = require('emissary');
var lazyReq = require('lazy-req')(require);
var lodash = lazyReq('lodash');
var jshint = lazyReq('jshint');
var jsxhint = lazyReq('jshint-jsx');
var path = require('path');
var cli = lazyReq('jshint/src/cli');
var reactDomPragma = require('react-dom-pragma');
var loadConfig = lazyReq('./load-config');
var plugin = module.exports;
var _;
var markersByEditorId = {};
var errorsByEditorId = {};
var subscriptionTooltips = new CompositeDisposable();

emissary.Subscriber.extend(plugin);

var SUPPORTED_GRAMMARS = ['source.js', 'source.jsx', 'source.js.jsx'];

var jsHintStatusBar = document.createElement('span');
jsHintStatusBar.setAttribute('id', 'jshint-statusbar');
jsHintStatusBar.classList.add('inline-block');

function updateStatusText(line, character, reason) {
	jsHintStatusBar.textContent = line && character && reason ? 'JSHint ' + line + ':' + character + ' ' + reason : '';
}

function getMarkersForEditor() {
	var editor = atom.workspace.getActiveTextEditor();

	if (editor && markersByEditorId[editor.id]) {
		return markersByEditorId[editor.id];
	}

	return {};
}

function getErrorsForEditor() {
	var editor = atom.workspace.getActiveTextEditor();

	if (editor && errorsByEditorId[editor.id]) {
		return errorsByEditorId[editor.id];
	}

	return [];
}

function clearOldMarkers(errors) {
	subscriptionTooltips.dispose();

	var rows = _.map(errors, function (error) {
		return getRowForError(error);
	});

	var oldMarkers = getMarkersForEditor();
	_.each(_.keys(oldMarkers), function (row) {
		if (!_.contains(rows, row)) {
			destroyMarkerAtRow(row);
		}
	});
}

function destroyMarkerAtRow(row) {
	var editor = atom.workspace.getActiveTextEditor();
	if (markersByEditorId[editor.id] && markersByEditorId[editor.id][row]) {
		markersByEditorId[editor.id][row].destroy();
		delete markersByEditorId[editor.id][row];
	}
}

function saveMarker(marker, row) {
	var editor = atom.workspace.getActiveTextEditor();

	if (!markersByEditorId[editor.id]) {
		markersByEditorId[editor.id] = {};
	}

	markersByEditorId[editor.id][row] = marker;
}

function getMarkerAtRow(row) {
	var editor = atom.workspace.getActiveTextEditor();

	if (!markersByEditorId[editor.id]) {
		return null;
	}

	return markersByEditorId[editor.id][row];
}

function updateStatusbar() {
	var statusBar = atom.views.getView(atom.workspace).querySelector('.status-bar');
	if (!statusBar) {
		return;
	}

	if (!jsHintStatusBar.parentNode) {
		statusBar.addLeftTile({ item: jsHintStatusBar });
	}

	var editor = atom.workspace.getActiveTextEditor();
	if (!editor || !errorsByEditorId[editor.id]) {
		updateStatusText();
		return;
	}

	var line = editor.getCursorBufferPosition().row + 1;
	var error = errorsByEditorId[editor.id][line] || _.first(_.compact(errorsByEditorId[editor.id]));
	error = error[0];

	updateStatusText(error.line, error.character, error.reason);
}

function getRowForError(error) {
	var line = error[0].line || 1; // JSHint reports `line: 0` when config error
	var row = line - 1;
	return row;
}

function displayError(error) {
	var row = getRowForError(error);

	if (getMarkerAtRow(row)) {
		return;
	}

	var editor = atom.workspace.getActiveTextEditor();
	var marker = editor.markBufferRange([[row, 0], [row, 1]]);
	editor.decorateMarker(marker, { type: 'line', 'class': 'jshint-line' });
	editor.decorateMarker(marker, { type: 'line-number', 'class': 'jshint-line-number' });
	saveMarker(marker, row);
	addReasons(marker, error);
}

function getReasonsForError(error) {
	return _.map(error, function (el) {
		return el.character + ': ' + el.reason;
	});
}

function addReasons(marker, error) {
	var row = getRowForError(error);
	var editorElement = atom.views.getView(atom.workspace.getActiveTextEditor());
	var reasons = '<div class="jshint-errors">' + getReasonsForError(error).join('<br>') + '</div>';

	var target = editorElement.shadowRoot.querySelectorAll('.jshint-line-number.line-number-' + row);
	var tooltip = atom.tooltips.add(target, {
		title: reasons,
		placement: 'bottom',
		delay: { show: 200 }
	});
	subscriptionTooltips.add(tooltip);
}

function lint() {
	var editor = atom.workspace.getActiveTextEditor();

	if (!editor) {
		return;
	}

	if (SUPPORTED_GRAMMARS.indexOf(editor.getGrammar().scopeName) === -1) {
		return;
	}

	var file = editor.getURI();

	// Hack to make JSHint look for .jshintignore in the correct dir
	// Because JSHint doesn't use its `cwd` option
	process.chdir(path.dirname(file));

	// Remove errors and don't lint if file is ignored in .jshintignore
	if (file && cli().gather({ args: [file] }).length === 0) {
		removeErrorsForEditorId(editor.id);
		displayErrors();
		removeMarkersForEditorId(editor.id);
		return;
	}

	var config = file ? loadConfig()(file) : {};

	var linter = atom.config.get('jshint.supportLintingJsx') || atom.config.get('jshint.transformJsx') ? jsxhint().JSXHINT : jshint().JSHINT;

	var origCode = editor.getText();
	var code = editor.getGrammar().scopeName === 'source.jsx' ? reactDomPragma(origCode) : origCode;
	var pragmaWasAdded = code !== origCode;

	try {
		linter(code, config, config.globals);
	} catch (err) {}

	removeErrorsForEditorId(editor.id);

	// workaround the errors array sometimes containing `null`
	var errors = _.compact(linter.errors);

	if (errors.length > 0) {
		// aggregate same-line errors
		var ret = [];
		_.each(errors, function (el) {
			if (pragmaWasAdded) {
				el.line--;
			}

			var l = el.line;

			if (Array.isArray(ret[l])) {
				ret[l].push(el);

				ret[l] = _.sortBy(ret[l], function (el) {
					return el.character;
				});
			} else {
				ret[l] = [el];
			}
		});

		errorsByEditorId[editor.id] = ret;
	}

	displayErrors();
}

var debouncedLint = null;

function displayErrors() {
	var errors = _.compact(getErrorsForEditor());
	clearOldMarkers(errors);
	updateStatusbar();
	_.each(errors, displayError);
}

var debouncedDisplayErrors = null;

function removeMarkersForEditorId(id) {
	if (markersByEditorId[id]) {
		delete markersByEditorId[id];
	}
}

function removeErrorsForEditorId(id) {
	if (errorsByEditorId[id]) {
		delete errorsByEditorId[id];
	}
}

function registerEvents() {
	lint();
	var workspaceElement = atom.views.getView(atom.workspace);

	atom.workspace.observeTextEditors(function (editor) {
		var buffer = editor.getBuffer();
		debouncedLint = debouncedLint || _.debounce(lint, 50);
		debouncedDisplayErrors = debouncedDisplayErrors || _.debounce(displayErrors, 200);

		editor.emitter.off('scroll-top-changed', debouncedDisplayErrors);
		buffer.emitter.off('did-save did-change-modified', debouncedLint);

		if (!atom.config.get('jshint.validateOnlyOnSave')) {
			buffer.onDidChangeModified(debouncedLint);
		}

		buffer.onDidSave(debouncedLint);

		editor.onDidChangeScrollTop(debouncedDisplayErrors);
	});

	workspaceElement.addEventListener('editor:will-be-removed', function (e, editorView) {
		if (editorView && editorView.editor) {
			removeErrorsForEditorId(editorView.editor.id);
			removeMarkersForEditorId(editorView.editor.id);
		}
	});

	workspaceElement.addEventListener('cursor:moved', updateStatusbar);
}

plugin.config = {
	validateOnlyOnSave: {
		type: 'boolean',
		'default': false
	},
	supportLintingJsx: {
		type: 'boolean',
		'default': false,
		title: 'Support Linting JSX'
	}
};

plugin.activate = function () {
	_ = lodash();
	registerEvents();
	plugin.subscribe(atom.config.observe('jshint.validateOnlyOnSave', registerEvents));
	atom.commands.add('atom-workspace', 'jshint:lint', lint);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9tazIvLmF0b20vcGFja2FnZXMvanNoaW50L2luZGV4LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFDQSxZQUFZLENBQUM7QUFDYixJQUFJLG1CQUFtQixHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxtQkFBbUIsQ0FBQztBQUM5RCxJQUFJLFFBQVEsR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDbkMsSUFBSSxPQUFPLEdBQUcsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQzNDLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUMvQixJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDL0IsSUFBSSxPQUFPLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQ3BDLElBQUksSUFBSSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUMzQixJQUFJLEdBQUcsR0FBRyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztBQUNwQyxJQUFJLGNBQWMsR0FBRyxPQUFPLENBQUMsa0JBQWtCLENBQUMsQ0FBQztBQUNqRCxJQUFJLFVBQVUsR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUM7QUFDMUMsSUFBSSxNQUFNLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQztBQUM1QixJQUFJLENBQUMsQ0FBQztBQUNOLElBQUksaUJBQWlCLEdBQUcsRUFBRSxDQUFDO0FBQzNCLElBQUksZ0JBQWdCLEdBQUcsRUFBRSxDQUFDO0FBQzFCLElBQUksb0JBQW9CLEdBQUcsSUFBSSxtQkFBbUIsRUFBRSxDQUFDOztBQUVyRCxRQUFRLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQzs7QUFFbkMsSUFBSSxrQkFBa0IsR0FBRyxDQUN4QixXQUFXLEVBQ1gsWUFBWSxFQUNaLGVBQWUsQ0FDZixDQUFDOztBQUVGLElBQUks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Q0FDekQsQ0FBQyIsImZpbGUiOiIvVXNlcnMvbWsyLy5hdG9tL3BhY2thZ2VzL2pzaGludC9pbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGdsb2JhbHMgYXRvbSAqL1xuJ3VzZSBzdHJpY3QnO1xudmFyIENvbXBvc2l0ZURpc3Bvc2FibGUgPSByZXF1aXJlKCdhdG9tJykuQ29tcG9zaXRlRGlzcG9zYWJsZTtcbnZhciBlbWlzc2FyeSA9IHJlcXVpcmUoJ2VtaXNzYXJ5Jyk7XG52YXIgbGF6eVJlcSA9IHJlcXVpcmUoJ2xhenktcmVxJykocmVxdWlyZSk7XG52YXIgbG9kYXNoID0gbGF6eVJlcSgnbG9kYXNoJyk7XG52YXIganNoaW50ID0gbGF6eVJlcSgnanNoaW50Jyk7XG52YXIganN4aGludCA9IGxhenlSZXEoJ2pzaGludC1qc3gnKTtcbnZhciBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xudmFyIGNsaSA9IGxhenlSZXEoJ2pzaGludC9zcmMvY2xpJyk7XG52YXIgcmVhY3REb21QcmFnbWEgPSByZXF1aXJlKCdyZWFjdC1kb20tcHJhZ21hJyk7XG52YXIgbG9hZENvbmZpZyA9IGxhenlSZXEoJy4vbG9hZC1jb25maWcnKTtcbnZhciBwbHVnaW4gPSBtb2R1bGUuZXhwb3J0cztcbnZhciBfO1xudmFyIG1hcmtlcnNCeUVkaXRvcklkID0ge307XG52YXIgZXJyb3JzQnlFZGl0b3JJZCA9IHt9O1xudmFyIHN1YnNjcmlwdGlvblRvb2x0aXBzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKTtcblxuZW1pc3NhcnkuU3Vic2NyaWJlci5leHRlbmQocGx1Z2luKTtcblxudmFyIFNVUFBPUlRFRF9HUkFNTUFSUyA9IFtcblx0J3NvdXJjZS5qcycsXG5cdCdzb3VyY2UuanN4Jyxcblx0J3NvdXJjZS5qcy5qc3gnXG5dO1xuXG52YXIganNIaW50U3RhdHVzQmFyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpO1xuanNIaW50U3RhdHVzQmFyLnNldEF0dHJpYnV0ZSgnaWQnLCAnanNoaW50LXN0YXR1c2JhcicpO1xuanNIaW50U3RhdHVzQmFyLmNsYXNzTGlzdC5hZGQoJ2lubGluZS1ibG9jaycpO1xuXG5mdW5jdGlvbiB1cGRhdGVTdGF0dXNUZXh0KGxpbmUsIGNoYXJhY3RlciwgcmVhc29uKSB7XG5cdGpzSGludFN0YXR1c0Jhci50ZXh0Q29udGVudCA9IGxpbmUgJiYgY2hhcmFjdGVyICYmIHJlYXNvbiA/ICdKU0hpbnQgJyArIGxpbmUgKyAnOicgKyBjaGFyYWN0ZXIgKyAnICcgKyByZWFzb24gOiAnJztcbn1cblxuZnVuY3Rpb24gZ2V0TWFya2Vyc0ZvckVkaXRvcigpIHtcblx0dmFyIGVkaXRvciA9IGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVRleHRFZGl0b3IoKTtcblxuXHRpZiAoZWRpdG9yICYmIG1hcmtlcnNCeUVkaXRvcklkW2VkaXRvci5pZF0pIHtcblx0XHRyZXR1cm4gbWFya2Vyc0J5RWRpdG9ySWRbZWRpdG9yLmlkXTtcblx0fVxuXG5cdHJldHVybiB7fTtcbn1cblxuZnVuY3Rpb24gZ2V0RXJyb3JzRm9yRWRpdG9yKCkge1xuXHR2YXIgZWRpdG9yID0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcigpO1xuXG5cdGlmIChlZGl0b3IgJiYgZXJyb3JzQnlFZGl0b3JJZFtlZGl0b3IuaWRdKSB7XG5cdFx0cmV0dXJuIGVycm9yc0J5RWRpdG9ySWRbZWRpdG9yLmlkXTtcblx0fVxuXG5cdHJldHVybiBbXTtcbn1cblxuZnVuY3Rpb24gY2xlYXJPbGRNYXJrZXJzKGVycm9ycykge1xuXHRzdWJzY3JpcHRpb25Ub29sdGlwcy5kaXNwb3NlKCk7XG5cblx0dmFyIHJvd3MgPSBfLm1hcChlcnJvcnMsIGZ1bmN0aW9uIChlcnJvcikge1xuXHRcdHJldHVybiBnZXRSb3dGb3JFcnJvcihlcnJvcik7XG5cdH0pO1xuXG5cdHZhciBvbGRNYXJrZXJzID0gZ2V0TWFya2Vyc0ZvckVkaXRvcigpO1xuXHRfLmVhY2goXy5rZXlzKG9sZE1hcmtlcnMpLCBmdW5jdGlvbiAocm93KSB7XG5cdFx0aWYgKCFfLmNvbnRhaW5zKHJvd3MsIHJvdykpIHtcblx0XHRcdGRlc3Ryb3lNYXJrZXJBdFJvdyhyb3cpO1xuXHRcdH1cblx0fSk7XG59XG5cbmZ1bmN0aW9uIGRlc3Ryb3lNYXJrZXJBdFJvdyhyb3cpIHtcblx0dmFyIGVkaXRvciA9IGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVRleHRFZGl0b3IoKTtcblx0aWYgKG1hcmtlcnNCeUVkaXRvcklkW2VkaXRvci5pZF0gJiYgbWFya2Vyc0J5RWRpdG9ySWRbZWRpdG9yLmlkXVtyb3ddKSB7XG5cdFx0bWFya2Vyc0J5RWRpdG9ySWRbZWRpdG9yLmlkXVtyb3ddLmRlc3Ryb3koKTtcblx0XHRkZWxldGUgbWFya2Vyc0J5RWRpdG9ySWRbZWRpdG9yLmlkXVtyb3ddO1xuXHR9XG59XG5cbmZ1bmN0aW9uIHNhdmVNYXJrZXIobWFya2VyLCByb3cpIHtcblx0dmFyIGVkaXRvciA9IGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVRleHRFZGl0b3IoKTtcblxuXHRpZiAoIW1hcmtlcnNCeUVkaXRvcklkW2VkaXRvci5pZF0pIHtcblx0XHRtYXJrZXJzQnlFZGl0b3JJZFtlZGl0b3IuaWRdID0ge307XG5cdH1cblxuXHRtYXJrZXJzQnlFZGl0b3JJZFtlZGl0b3IuaWRdW3Jvd10gPSBtYXJrZXI7XG59XG5cbmZ1bmN0aW9uIGdldE1hcmtlckF0Um93KHJvdykge1xuXHR2YXIgZWRpdG9yID0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcigpO1xuXG5cdGlmICghbWFya2Vyc0J5RWRpdG9ySWRbZWRpdG9yLmlkXSkge1xuXHRcdHJldHVybiBudWxsO1xuXHR9XG5cblx0cmV0dXJuIG1hcmtlcnNCeUVkaXRvcklkW2VkaXRvci5pZF1bcm93XTtcbn1cblxuZnVuY3Rpb24gdXBkYXRlU3RhdHVzYmFyKCkge1xuXHR2YXIgc3RhdHVzQmFyID0gYXRvbS52aWV3cy5nZXRWaWV3KGF0b20ud29ya3NwYWNlKS5xdWVyeVNlbGVjdG9yKCcuc3RhdHVzLWJhcicpO1xuXHRpZiAoIXN0YXR1c0Jhcikge1xuXHRcdHJldHVybjtcblx0fVxuXG5cdGlmICghanNIaW50U3RhdHVzQmFyLnBhcmVudE5vZGUpIHtcblx0XHRzdGF0dXNCYXIuYWRkTGVmdFRpbGUoe2l0ZW06IGpzSGludFN0YXR1c0Jhcn0pO1xuXHR9XG5cblx0dmFyIGVkaXRvciA9IGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVRleHRFZGl0b3IoKTtcblx0aWYgKCFlZGl0b3IgfHwgIWVycm9yc0J5RWRpdG9ySWRbZWRpdG9yLmlkXSkge1xuXHRcdHVwZGF0ZVN0YXR1c1RleHQoKTtcblx0XHRyZXR1cm47XG5cdH1cblxuXHR2YXIgbGluZSA9IGVkaXRvci5nZXRDdXJzb3JCdWZmZXJQb3NpdGlvbigpLnJvdyArIDE7XG5cdHZhciBlcnJvciA9IGVycm9yc0J5RWRpdG9ySWRbZWRpdG9yLmlkXVtsaW5lXSB8fCBfLmZpcnN0KF8uY29tcGFjdChlcnJvcnNCeUVkaXRvcklkW2VkaXRvci5pZF0pKTtcblx0ZXJyb3IgPSBlcnJvclswXTtcblxuXHR1cGRhdGVTdGF0dXNUZXh0KGVycm9yLmxpbmUsIGVycm9yLmNoYXJhY3RlciwgZXJyb3IucmVhc29uKTtcbn1cblxuZnVuY3Rpb24gZ2V0Um93Rm9yRXJyb3IoZXJyb3IpIHtcblx0dmFyIGxpbmUgPSBlcnJvclswXS5saW5lIHx8IDE7IC8vIEpTSGludCByZXBvcnRzIGBsaW5lOiAwYCB3aGVuIGNvbmZpZyBlcnJvclxuXHR2YXIgcm93ID0gbGluZSAtIDE7XG5cdHJldHVybiByb3c7XG59XG5cbmZ1bmN0aW9uIGRpc3BsYXlFcnJvcihlcnJvcikge1xuXHR2YXIgcm93ID0gZ2V0Um93Rm9yRXJyb3IoZXJyb3IpO1xuXG5cdGlmIChnZXRNYXJrZXJBdFJvdyhyb3cpKSB7XG5cdFx0cmV0dXJuO1xuXHR9XG5cblx0dmFyIGVkaXRvciA9IGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVRleHRFZGl0b3IoKTtcblx0dmFyIG1hcmtlciA9IGVkaXRvci5tYXJrQnVmZmVyUmFuZ2UoW1tyb3csIDBdLCBbcm93LCAxXV0pO1xuXHRlZGl0b3IuZGVjb3JhdGVNYXJrZXIobWFya2VyLCB7dHlwZTogJ2xpbmUnLCBjbGFzczogJ2pzaGludC1saW5lJ30pO1xuXHRlZGl0b3IuZGVjb3JhdGVNYXJrZXIobWFya2VyLCB7dHlwZTogJ2xpbmUtbnVtYmVyJywgY2xhc3M6ICdqc2hpbnQtbGluZS1udW1iZXInfSk7XG5cdHNhdmVNYXJrZXIobWFya2VyLCByb3cpO1xuXHRhZGRSZWFzb25zKG1hcmtlciwgZXJyb3IpO1xufVxuXG5mdW5jdGlvbiBnZXRSZWFzb25zRm9yRXJyb3IoZXJyb3IpIHtcblx0cmV0dXJuIF8ubWFwKGVycm9yLCBmdW5jdGlvbiAoZWwpIHtcblx0XHRyZXR1cm4gZWwuY2hhcmFjdGVyICsgJzogJyArIGVsLnJlYXNvbjtcblx0fSk7XG59XG5cbmZ1bmN0aW9uIGFkZFJlYXNvbnMobWFya2VyLCBlcnJvcikge1xuXHR2YXIgcm93ID0gZ2V0Um93Rm9yRXJyb3IoZXJyb3IpO1xuXHR2YXIgZWRpdG9yRWxlbWVudCA9IGF0b20udmlld3MuZ2V0VmlldyhhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVUZXh0RWRpdG9yKCkpO1xuXHR2YXIgcmVhc29ucyA9ICc8ZGl2IGNsYXNzPVwianNoaW50LWVycm9yc1wiPicgKyBnZXRSZWFzb25zRm9yRXJyb3IoZXJyb3IpLmpvaW4oJzxicj4nKSArICc8L2Rpdj4nO1xuXG5cdHZhciB0YXJnZXQgPSBlZGl0b3JFbGVtZW50LnNoYWRvd1Jvb3QucXVlcnlTZWxlY3RvckFsbCgnLmpzaGludC1saW5lLW51bWJlci5saW5lLW51bWJlci0nICsgcm93KTtcblx0dmFyIHRvb2x0aXAgPSBhdG9tLnRvb2x0aXBzLmFkZCh0YXJnZXQsIHtcblx0XHR0aXRsZTogcmVhc29ucyxcblx0XHRwbGFjZW1lbnQ6ICdib3R0b20nLFxuXHRcdGRlbGF5OiB7IHNob3c6IDIwMCB9XG5cdH0pO1xuXHRzdWJzY3JpcHRpb25Ub29sdGlwcy5hZGQodG9vbHRpcCk7XG59XG5cbmZ1bmN0aW9uIGxpbnQoKSB7XG5cdHZhciBlZGl0b3IgPSBhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVUZXh0RWRpdG9yKCk7XG5cblx0aWYgKCFlZGl0b3IpIHtcblx0XHRyZXR1cm47XG5cdH1cblxuXHRpZiAoU1VQUE9SVEVEX0dSQU1NQVJTLmluZGV4T2YoZWRpdG9yLmdldEdyYW1tYXIoKS5zY29wZU5hbWUpID09PSAtMSkge1xuXHRcdHJldHVybjtcblx0fVxuXG5cdHZhciBmaWxlID0gZWRpdG9yLmdldFVSSSgpO1xuXG5cdC8vIEhhY2sgdG8gbWFrZSBKU0hpbnQgbG9vayBmb3IgLmpzaGludGlnbm9yZSBpbiB0aGUgY29ycmVjdCBkaXJcblx0Ly8gQmVjYXVzZSBKU0hpbnQgZG9lc24ndCB1c2UgaXRzIGBjd2RgIG9wdGlvblxuXHRwcm9jZXNzLmNoZGlyKHBhdGguZGlybmFtZShmaWxlKSk7XG5cblx0Ly8gUmVtb3ZlIGVycm9ycyBhbmQgZG9uJ3QgbGludCBpZiBmaWxlIGlzIGlnbm9yZWQgaW4gLmpzaGludGlnbm9yZVxuXHRpZiAoZmlsZSAmJiBjbGkoKS5nYXRoZXIoe2FyZ3M6IFtmaWxlXX0pLmxlbmd0aCA9PT0gMCkge1xuXHRcdHJlbW92ZUVycm9yc0ZvckVkaXRvcklkKGVkaXRvci5pZCk7XG5cdFx0ZGlzcGxheUVycm9ycygpO1xuXHRcdHJlbW92ZU1hcmtlcnNGb3JFZGl0b3JJZChlZGl0b3IuaWQpO1xuXHRcdHJldHVybjtcblx0fVxuXG5cdHZhciBjb25maWcgPSBmaWxlID8gbG9hZENvbmZpZygpKGZpbGUpIDoge307XG5cblx0dmFyIGxpbnRlciA9IChhdG9tLmNvbmZpZy5nZXQoJ2pzaGludC5zdXBwb3J0TGludGluZ0pzeCcpIHx8IGF0b20uY29uZmlnLmdldCgnanNoaW50LnRyYW5zZm9ybUpzeCcpKSA/IGpzeGhpbnQoKS5KU1hISU5UIDoganNoaW50KCkuSlNISU5UO1xuXG5cdHZhciBvcmlnQ29kZSA9IGVkaXRvci5nZXRUZXh0KCk7XG5cdHZhciBjb2RlID0gZWRpdG9yLmdldEdyYW1tYXIoKS5zY29wZU5hbWUgPT09ICdzb3VyY2UuanN4JyA/IHJlYWN0RG9tUHJhZ21hKG9yaWdDb2RlKSA6IG9yaWdDb2RlO1xuXHR2YXIgcHJhZ21hV2FzQWRkZWQgPSBjb2RlICE9PSBvcmlnQ29kZTtcblxuXHR0cnkge1xuXHRcdGxpbnRlcihjb2RlLCBjb25maWcsIGNvbmZpZy5nbG9iYWxzKTtcblx0fSBjYXRjaCAoZXJyKSB7fVxuXG5cdHJlbW92ZUVycm9yc0ZvckVkaXRvcklkKGVkaXRvci5pZCk7XG5cblx0Ly8gd29ya2Fyb3VuZCB0aGUgZXJyb3JzIGFycmF5IHNvbWV0aW1lcyBjb250YWluaW5nIGBudWxsYFxuXHR2YXIgZXJyb3JzID0gXy5jb21wYWN0KGxpbnRlci5lcnJvcnMpO1xuXG5cdGlmIChlcnJvcnMubGVuZ3RoID4gMCkge1xuXHRcdC8vIGFnZ3JlZ2F0ZSBzYW1lLWxpbmUgZXJyb3JzXG5cdFx0dmFyIHJldCA9IFtdO1xuXHRcdF8uZWFjaChlcnJvcnMsIGZ1bmN0aW9uIChlbCkge1xuXHRcdFx0aWYgKHByYWdtYVdhc0FkZGVkKSB7XG5cdFx0XHRcdGVsLmxpbmUtLTtcblx0XHRcdH1cblxuXHRcdFx0dmFyIGwgPSBlbC5saW5lO1xuXG5cdFx0XHRpZiAoQXJyYXkuaXNBcnJheShyZXRbbF0pKSB7XG5cdFx0XHRcdHJldFtsXS5wdXNoKGVsKTtcblxuXHRcdFx0XHRyZXRbbF0gPSBfLnNvcnRCeShyZXRbbF0sIGZ1bmN0aW9uIChlbCkge1xuXHRcdFx0XHRcdHJldHVybiBlbC5jaGFyYWN0ZXI7XG5cdFx0XHRcdH0pO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0cmV0W2xdID0gW2VsXTtcblx0XHRcdH1cblx0XHR9KTtcblxuXHRcdGVycm9yc0J5RWRpdG9ySWRbZWRpdG9yLmlkXSA9IHJldDtcblx0fVxuXG5cdGRpc3BsYXlFcnJvcnMoKTtcbn1cblxudmFyIGRlYm91bmNlZExpbnQgPSBudWxsO1xuXG5mdW5jdGlvbiBkaXNwbGF5RXJyb3JzKCkge1xuXHR2YXIgZXJyb3JzID0gXy5jb21wYWN0KGdldEVycm9yc0ZvckVkaXRvcigpKTtcblx0Y2xlYXJPbGRNYXJrZXJzKGVycm9ycyk7XG5cdHVwZGF0ZVN0YXR1c2JhcigpO1xuXHRfLmVhY2goZXJyb3JzLCBkaXNwbGF5RXJyb3IpO1xufVxuXG52YXIgZGVib3VuY2VkRGlzcGxheUVycm9ycyA9IG51bGw7XG5cbmZ1bmN0aW9uIHJlbW92ZU1hcmtlcnNGb3JFZGl0b3JJZChpZCkge1xuXHRpZiAobWFya2Vyc0J5RWRpdG9ySWRbaWRdKSB7XG5cdFx0ZGVsZXRlIG1hcmtlcnNCeUVkaXRvcklkW2lkXTtcblx0fVxufVxuXG5mdW5jdGlvbiByZW1vdmVFcnJvcnNGb3JFZGl0b3JJZChpZCkge1xuXHRpZiAoZXJyb3JzQnlFZGl0b3JJZFtpZF0pIHtcblx0XHRkZWxldGUgZXJyb3JzQnlFZGl0b3JJZFtpZF07XG5cdH1cbn1cblxuZnVuY3Rpb24gcmVnaXN0ZXJFdmVudHMoKSB7XG5cdGxpbnQoKTtcblx0dmFyIHdvcmtzcGFjZUVsZW1lbnQgPSBhdG9tLnZpZXdzLmdldFZpZXcoYXRvbS53b3Jrc3BhY2UpO1xuXG5cdGF0b20ud29ya3NwYWNlLm9ic2VydmVUZXh0RWRpdG9ycyhmdW5jdGlvbiAoZWRpdG9yKSB7XG5cdFx0dmFyIGJ1ZmZlciA9IGVkaXRvci5nZXRCdWZmZXIoKTtcblx0XHRkZWJvdW5jZWRMaW50ID0gZGVib3VuY2VkTGludCB8fCBfLmRlYm91bmNlKGxpbnQsIDUwKTtcblx0XHRkZWJvdW5jZWREaXNwbGF5RXJyb3JzID0gZGVib3VuY2VkRGlzcGxheUVycm9ycyB8fCBfLmRlYm91bmNlKGRpc3BsYXlFcnJvcnMsIDIwMCk7XG5cblx0XHRlZGl0b3IuZW1pdHRlci5vZmYoJ3Njcm9sbC10b3AtY2hhbmdlZCcsIGRlYm91bmNlZERpc3BsYXlFcnJvcnMpO1xuXHRcdGJ1ZmZlci5lbWl0dGVyLm9mZignZGlkLXNhdmUgZGlkLWNoYW5nZS1tb2RpZmllZCcsIGRlYm91bmNlZExpbnQpO1xuXG5cdFx0aWYgKCFhdG9tLmNvbmZpZy5nZXQoJ2pzaGludC52YWxpZGF0ZU9ubHlPblNhdmUnKSkge1xuXHRcdFx0YnVmZmVyLm9uRGlkQ2hhbmdlTW9kaWZpZWQoZGVib3VuY2VkTGludCk7XG5cdFx0fVxuXG5cdFx0YnVmZmVyLm9uRGlkU2F2ZShkZWJvdW5jZWRMaW50KTtcblxuXHRcdGVkaXRvci5vbkRpZENoYW5nZVNjcm9sbFRvcChkZWJvdW5jZWREaXNwbGF5RXJyb3JzKTtcblx0fSk7XG5cblx0d29ya3NwYWNlRWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdlZGl0b3I6d2lsbC1iZS1yZW1vdmVkJywgZnVuY3Rpb24gKGUsIGVkaXRvclZpZXcpIHtcblx0XHRpZiAoZWRpdG9yVmlldyAmJiBlZGl0b3JWaWV3LmVkaXRvcikge1xuXHRcdFx0cmVtb3ZlRXJyb3JzRm9yRWRpdG9ySWQoZWRpdG9yVmlldy5lZGl0b3IuaWQpO1xuXHRcdFx0cmVtb3ZlTWFya2Vyc0ZvckVkaXRvcklkKGVkaXRvclZpZXcuZWRpdG9yLmlkKTtcblx0XHR9XG5cdH0pO1xuXG5cdHdvcmtzcGFjZUVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY3Vyc29yOm1vdmVkJywgdXBkYXRlU3RhdHVzYmFyKTtcbn1cblxucGx1Z2luLmNvbmZpZyA9IHtcblx0dmFsaWRhdGVPbmx5T25TYXZlOiB7XG5cdFx0dHlwZTogJ2Jvb2xlYW4nLFxuXHRcdGRlZmF1bHQ6IGZhbHNlXG5cdH0sXG5cdHN1cHBvcnRMaW50aW5nSnN4OiB7XG5cdFx0dHlwZTogJ2Jvb2xlYW4nLFxuXHRcdGRlZmF1bHQ6IGZhbHNlLFxuXHRcdHRpdGxlOiAnU3VwcG9ydCBMaW50aW5nIEpTWCdcblx0fVxufTtcblxucGx1Z2luLmFjdGl2YXRlID0gZnVuY3Rpb24gKCkge1xuXHRfID0gbG9kYXNoKCk7XG5cdHJlZ2lzdGVyRXZlbnRzKCk7XG5cdHBsdWdpbi5zdWJzY3JpYmUoYXRvbS5jb25maWcub2JzZXJ2ZSgnanNoaW50LnZhbGlkYXRlT25seU9uU2F2ZScsIHJlZ2lzdGVyRXZlbnRzKSk7XG5cdGF0b20uY29tbWFuZHMuYWRkKCdhdG9tLXdvcmtzcGFjZScsICdqc2hpbnQ6bGludCcsIGxpbnQpO1xufTtcbiJdfQ==